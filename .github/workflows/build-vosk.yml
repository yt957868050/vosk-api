  name: Build Vosk ARM64 JNI                                                                                                                                                        
                                                                                                                                                                                    
  on:                                                                                                                                                                               
    workflow_dispatch:                                                                                                                                                              
                                                                                                                                                                                    
  jobs:                                                                                                                                                                             
    build-arm64:                                                                                                                                                                    
      runs-on: ubuntu-22.04-arm                                                                                                                                                     
                                                                                                                                                                                    
      steps:                                                                                                                                                                        
        - uses: actions/checkout@v4                                                                                                                                                 
          with:                                                                                                                                                                     
            fetch-depth: 1                                                                                                                                                          
                                                                                                                                                                                    
        - name: Install dependencies                                                                                                                                                
          run: |                                                                                                                                                                    
            set -eux                                                                                                                                                                
            sudo apt-get update                                                                                                                                                     
            sudo apt-get install -y \                                                                                                                                               
              git curl ca-certificates build-essential cmake ninja-build swig \                                                                                                     
              openjdk-8-jdk python3 python3-pip python3-setuptools python-is-python3 \                                                                                              
              python2 python2-dev wget unzip subversion gfortran \                                                                                                                  
              maven libtool automake autoconf zlib1g-dev \                                                                                                                          
              libopenblas-dev liblapacke-dev libomp5 libgfortran5 \                                                                                                                 
              sox ffmpeg pkg-config                                                                                                                                                 
                                                                                                                                                                                    
        - name: Build Kaldi & Vosk                                                                                                                                                  
          env:                                                                                                                                                                      
            MAKEFLAGS: "-j2"                                                                                                                                                        
          run: |                                                                                                                                                                    
            set -eux                                                                                                                                                                
                                                                                                                                                                                    
            WORKDIR="${PWD}"                                                                                                                                                        
            BUILD_DIR="${RUNNER_TEMP}/vosk-build"                                                                                                                                   
            KALDI_DIR="${BUILD_DIR}/kaldi"                                                                                                                                          
            VOSK_DIR="${BUILD_DIR}/vosk-api"                                                                                                                                        
            OPENBLAS_ROOT="${BUILD_DIR}/openblas-root"                                                                                                                              
                                                                                                                                                                                    
            mkdir -p "${BUILD_DIR}" "${OPENBLAS_ROOT}/lib"                                                                                                                          
                                                                                                                                                                                    
            # 收集系统 OpenBLAS (及 lapacke) 库，Kaldi configure 只认 lib/libopenblas.so                                                                                            
            for so in /usr/lib/aarch64-linux-gnu/libopenblas.so*; do                                                                                                                
              cp -L "${so}" "${OPENBLAS_ROOT}/lib/"                                                                                                                                 
            done                                                                                                                                                                    
            for so in /usr/lib/aarch64-linux-gnu/liblapacke.so*; do                                                                                                                 
              cp -L "${so}" "${OPENBLAS_ROOT}/lib/"                                                                                                                                 
            done                                                                                                                                                                    
            ln -s /usr/include "${OPENBLAS_ROOT}/include"                                                                                                                           
                                                                                                                                                                                    
            # -- Kaldi --                                                                                                                                                           
            git clone --depth 1 https://github.com/alphacep/kaldi.git "${KALDI_DIR}"                                                                                                
            export KALDI_ROOT="${KALDI_DIR}"                                                                                                                                        
                                                                                                                                                                                    
            cd "${KALDI_DIR}/tools"                                                                                                                                                 
            extras/check_dependencies.sh || true                                                                                                                                    
            make                                                                                                                                                                    
                                                                                                                                                                                    
            cd "${KALDI_DIR}/src"                                                                                                                                                   
            ./configure --shared --static --use-cuda=no --openblas-root="${OPENBLAS_ROOT}"                                                                                          
            make clean                                                                                                                                                              
            make                                                                                                                                                                    
                                                                                                                                                                                    
            # -- Vosk JNI --                                                                                                                                                        
            git clone --depth 1 --branch v0.3.45 https://github.com/alphacep/vosk-api.git "${VOSK_DIR}"                                                                             
            cd "${VOSK_DIR}"                                                                                                                                                        
                                                                                                                                                                                    
            export KALDI_ROOT="${KALDI_DIR}"                                                                                                                                        
            export LD_LIBRARY_PATH="${KALDI_ROOT}/src/lib:${LD_LIBRARY_PATH:-}"                                                                                                     
                                                                                                                                                                                    
            make -C src                                                                                                                                                             
            make java                                                                                                                                                               
                                                                                                                                                                                    
            strip java/lib/linux-aarch64/libvosk.so                                                                                                                                 
            strip java/lib/linux-aarch64/libvosk_jni.so                                                                                                                             
                                                                                                                                                                                    
            mkdir -p "${WORKDIR}/artifacts/lib"                                                                                                                                     
            cp java/lib/linux-aarch64/libvosk.so      "${WORKDIR}/artifacts/lib/"                                                                                                   
            cp java/lib/linux-aarch64/libvosk_jni.so  "${WORKDIR}/artifacts/lib/"                                                                                                   
            cp java/lib/linux-aarch64/vosk.jar        "${WORKDIR}/artifacts/"                                                                                                       
                                                                                                                                                                                    
            rm -rf "${BUILD_DIR}"                                                                                                                                                   
                                                                                                                                                                                    
        - name: List artifacts                                                                                                                                                      
          run: ls -R artifacts                                                                                                                                                      
                                                                                                                                                                                    
        - name: Upload artifacts                                                                                                                                                    
          uses: actions/upload-artifact@v4                                                                                                                                          
          with:                                                                                                                                                                     
            name: vosk-arm64-jni                                                                                                                                                    
            path: artifacts                                                                                                                                                         
                                
