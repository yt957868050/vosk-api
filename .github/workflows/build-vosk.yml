  name: Build Vosk ARM64                                                                                                                                                            
                                                                                                                                                                                    
  on:                                                                                                                                                                               
    workflow_dispatch:                                                                                                                                                              
                                                                                                                                                                                    
  jobs:                                                                                                                                                                             
    build:                                                                                                                                                                          
      runs-on: ubuntu-22.04-arm                                                                                                                                                     
                                                                                                                                                                                    
      steps:                                                                                                                                                                        
        - name: Checkout (placeholder)                                                                                                                                              
          uses: actions/checkout@v4                                                                                                                                                 
                                                                                                                                                                                    
        - name: Install build dependencies                                                                                                                                          
          run: |                                                                                                                                                                    
            sudo apt-get update                                                                                                                                                     
            sudo apt-get install -y --no-install-recommends \                                                                                                                       
              build-essential gfortran git cmake pkg-config \                                                                                                                       
              python2 swig zlib1g-dev libtool autoconf automake \                                                                                                                   
              sox openjdk-17-jdk curl unzip rsync                                                                                                                                   
                                                                                                                                                                                    
        - name: Build OpenBLAS, Kaldi and Vosk                                                                                                                                      
          env:                                                                                                                                                                      
            BUILD_ROOT: ${{ runner.temp }}/vosk-build                                                                                                                               
          run: |                                                                                                                                                                    
            set -euxo pipefail                                                                                                                                                      
                                                                                                                                                                                    
            OPENBLAS_SRC="${BUILD_ROOT}/OpenBLAS"                                                                                                                                   
            OPENBLAS_PREFIX="${BUILD_ROOT}/openblas-install"                                                                                                                        
            KALDI_ROOT="${BUILD_ROOT}/kaldi"                                                                                                                                        
            VOSK_ROOT="${BUILD_ROOT}/vosk"                                                                                                                                          
            ARTIFACT_DIR="${BUILD_ROOT}/artifacts"                                                                                                                                  
                                                                                                                                                                                    
            mkdir -p "${BUILD_ROOT}" "${OPENBLAS_PREFIX}" "${ARTIFACT_DIR}"                                                                                                         
                                                                                                                                                                                    
            git clone --depth 1 https://github.com/OpenMathLib/OpenBLAS.git "${OPENBLAS_SRC}"                                                                                       
            make -C "${OPENBLAS_SRC}" -j"$(nproc)" TARGET=ARMV8 USE_OPENMP=0 BINARY=64                                                                                              
            make -C "${OPENBLAS_SRC}" -j"$(nproc)" TARGET=ARMV8 USE_OPENMP=0 BINARY=64 lapacke                                                                                      
            make -C "${OPENBLAS_SRC}" PREFIX="${OPENBLAS_PREFIX}" install                                                                                                           
                                                                                                                                                                                    
            git clone --depth 1 https://github.com/alphacep/kaldi.git "${KALDI_ROOT}"                                                                                               
            pushd "${KALDI_ROOT}/tools"                                                                                                                                             
            make -j"$(nproc)" OPENFST_CONFIGURE="--enable-static --enable-shared --with-pic --enable-ngram-fsts"                                                                    
            popd                                                                                                                                                                    
                                                                                                                                                                                    
            pushd "${KALDI_ROOT}/src"                                                                                                                                               
            CFLAGS='-fPIC -O2 -march=armv8-a' \                                                                                                                                     
            CXXFLAGS='-fPIC -O2 -march=armv8-a -std=c++14' \                                                                                                                        
            ./configure --shared --static --use-cuda=no --openblas-root="${OPENBLAS_PREFIX}"                                                                                        
            make -j"$(nproc)" online2 decoder ivector gmm tree feat lat lm rnnlm hmm nnet3 transform cudamatrix matrix fstext util base                                             
            popd                                                                                                                                                                    
                                                                                                                                                                                    
            git clone --depth 1 --branch v0.3.45 https://github.com/alphacep/vosk-api.git "${VOSK_ROOT}"                                                                            
            pushd "${VOSK_ROOT}"                                                                                                                                                    
            sed -i 's|#include "decoder/decoder-wrappers.h"|#include "decoder/decoder-wrappers.h"\n#include "lat/word-align-lattice.h"|' src/recognizer.cc                          
            sed -i 's/WordAlignLatticePartial(/kaldi::WordAlignLattice(/g' src/recognizer.cc                                                                                        
            sed -i 's|install/lib/liblapacke.a install/lib/libf2c.a|install/lib/liblapacke.a|' src/Makefile                                                                         
                                                                                                                                                                                    
            export KALDI_ROOT="${KALDI_ROOT}"                                                                                                                                       
            export LD_LIBRARY_PATH="${KALDI_ROOT}/src/lib:${LD_LIBRARY_PATH:-}"                                                                                                     
            make -C src clean                                                                                                                                                       
            make -C src -j"$(nproc)"                                                                                                                                                
                                                                                                                                                                                    
            swig -java -c++ -package org.vosk \                                                                                                                                     
              -outdir java/src/main/java/org/vosk \                                                                                                                                 
              -o java/src/main/jni/vosk_wrap.cxx \                                                                                                                                  
              java/src/main/swig/vosk.i                                                                                                                                             
                                                                                                                                                                                    
            JAVA_HOME="$(dirname "$(dirname "$(readlink -f "$(which javac)")")")"                                                                                                   
            g++ -shared -fPIC -std=c++17 \                                                                                                                                          
              -I"${JAVA_HOME}/include" \                                                                                                                                            
              -I"${JAVA_HOME}/include/linux" \                                                                                                                                      
              -I"${KALDI_ROOT}/src" \                                                                                                                                               
              -I"${KALDI_ROOT}/tools/openfst/include" \                                                                                                                             
              -I"${OPENBLAS_PREFIX}/include" \                                                                                                                                      
              -I"${VOSK_ROOT}/src" \                                                                                                                                                
              java/src/main/jni/vosk_wrap.cxx \                                                                                                                                     
              -L"${VOSK_ROOT}/src" -lvosk \                                                                                                                                         
              -L"${KALDI_ROOT}/src/lib" \                                                                                                                                           
              -lonline2 -ldecoder -livector -lgmm -ltree -lfeat -llat -llm -lrnnlm \                                                                                                
              -lhmm -lnnet3 -ltransform -lcudamatrix -lmatrix -lutil -lbase -lfstext \                                                                                              
              -lfst -lfstngram \                                                                                                                                                    
              -L"${OPENBLAS_PREFIX}/lib" -lopenblas \                                                                                                                               
              -lpthread -ldl -lm -lgfortran \                                                                                                                                       
              -Wl,-rpath,'$ORIGIN' \                                                                                                                                                
              -o "${ARTIFACT_DIR}/libvosk_jni.so"                                                                                                                                   
                                                                                                                                                                                    
            cp src/libvosk.so "${ARTIFACT_DIR}/"                                                                                                                                    
            mkdir -p "${ARTIFACT_DIR}/include"                                                                                                                                      
            cp src/vosk_api.h "${ARTIFACT_DIR}/include/"                                                                                                                            
                                                                                                                                                                                    
            tar -czf "${BUILD_ROOT}/vosk-arm64-libs.tar.gz" -C "${ARTIFACT_DIR}" .                                                                                                  
            popd                                                                                                                                                                    
                                                                                                                                                                                    
        - name: Upload artifacts                                                                                                                                                    
          uses: actions/upload-artifact@v4                                                                                                                                          
          with:                                                                                                                                                                     
            name: vosk-arm64-libs                                                                                                                                                   
            path: ${{ runner.temp }}/vosk-build/vosk-arm64-libs.tar.gz
