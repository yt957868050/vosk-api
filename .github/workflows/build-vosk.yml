  name: Build Vosk ARM64 JNI                                                                                                                                                        
                                                                                                                                                                                    
  on:                                                                                                                                                                               
    workflow_dispatch:                                                                                                                                                              
                                                                                                                                                                                    
  jobs:                                                                                                                                                                             
    build-arm64:                                                                                                                                                                    
      runs-on: ubuntu-22.04-arm                                                                                                                                                     
                                                                                                                                                                                    
      steps:                                                                                                                                                                        
        - uses: actions/checkout@v4                                                                                                                                                 
          with:                                                                                                                                                                     
            fetch-depth: 1                                                                                                                                                          
                                                                                                                                                                                    
        - name: Install dependencies                                                                                                                                                
          run: |                                                                                                                                                                    
            set -eux                                                                                                                                                                
            sudo apt-get update                                                                                                                                                     
            packages=(                                                                                                                                                              
              git curl ca-certificates build-essential cmake ninja-build swig                                                                                                       
              openjdk-8-jdk python3 python3-pip python3-setuptools python-is-python3                                                                                                
              python2 python2-dev wget unzip subversion gfortran                                                                                                                    
              maven libtool automake autoconf zlib1g-dev libomp5 libgfortran5                                                                                                       
              sox ffmpeg pkg-config make liblapack-dev                                                                                                                              
            )                                                                                                                                                                       
            sudo apt-get install -y "${packages[@]}"                                                                                                                                
            sudo apt-get clean                                                                                                                                                      
            sudo rm -rf /var/lib/apt/lists/*                                                                                                                                        
                                                                                                                                                                                    
        - name: Build Kaldi & Vosk                                                                                                                                                  
          env:                                                                                                                                                                      
            MAKEFLAGS: "-j2"                                                                                                                                                        
          run: |                                                                                                                                                                    
            set -eux                                                                                                                                                                
            WORKDIR="${PWD}"                                                                                                                                                        
            BUILD_DIR="${RUNNER_TEMP}/vosk-build"                                                                                                                                   
            OPENBLAS_ROOT="${BUILD_DIR}/openblas-install"                                                                                                                           
            KALDI_DIR="${BUILD_DIR}/kaldi"                                                                                                                                          
            VOSK_DIR="${BUILD_DIR}/vosk-api"                                                                                                                                        
                                                                                                                                                                                    
            mkdir -p "${BUILD_DIR}" "${OPENBLAS_ROOT}"                                                                                                                              
                                                                                                                                                                                    
            OPENBLAS_VERSION="0.3.13"                                                                                                                                               
            OPENBLAS_ARCHIVE="OpenBLAS-${OPENBLAS_VERSION}.tar.gz"                                                                                                                  
            OPENBLAS_URL="https://codeload.github.com/OpenMathLib/OpenBLAS/tar.gz/refs/tags/v${OPENBLAS_VERSION}"                                                                   
                                                                                                                                                                                    
            cd "${BUILD_DIR}"                                                                                                                                                       
            curl -L "${OPENBLAS_URL}" -o "${OPENBLAS_ARCHIVE}"                                                                                                                      
            tar -xf "${OPENBLAS_ARCHIVE}"                                                                                                                                           
            OPENBLAS_SRC_DIR="${BUILD_DIR}/OpenBLAS-${OPENBLAS_VERSION}"                                                                                                            
            cd "${OPENBLAS_SRC_DIR}"                                                                                                                                                
            make TARGET=ARMV8 BINARY=64                                                                                                                                             
            make PREFIX="${OPENBLAS_ROOT}" install                                                                                                                                  
            cd "${BUILD_DIR}"                                                                                                                                                       
            rm -rf "${OPENBLAS_ARCHIVE}" "${OPENBLAS_SRC_DIR}"                                                                                                                      
                                                                                                                                                                                    
            git clone --depth 1 https://github.com/alphacep/kaldi.git "${KALDI_DIR}"                                                                                                
            export KALDI_ROOT="${KALDI_DIR}"                                                                                                                                        
                                                                                                                                                                                    
            mkdir -p "${KALDI_ROOT}/tools/OpenBLAS"                                                                                                                                 
            ln -sfn "${OPENBLAS_ROOT}" "${KALDI_ROOT}/tools/OpenBLAS/install"                                                                                                       
                                                                                                                                                                                    
            if [ -f /usr/lib/aarch64-linux-gnu/liblapack.a ]; then                                                                                                                  
              ln -sfn /usr/lib/aarch64-linux-gnu/liblapack.a "${KALDI_ROOT}/tools/OpenBLAS/install/lib/liblapack.a"                                                                 
            else                                                                                                                                                                    
              ln -sfn "${OPENBLAS_ROOT}/lib/libopenblas.a" "${KALDI_ROOT}/tools/OpenBLAS/install/lib/liblapack.a"                                                                   
            fi                                                                                                                                                                      
                                                                                                                                                                                    
            if [ -f /usr/lib/aarch64-linux-gnu/liblapacke.a ]; then                                                                                                                 
              ln -sfn /usr/lib/aarch64-linux-gnu/liblapacke.a "${KALDI_ROOT}/tools/OpenBLAS/install/lib/liblapacke.a"                                                               
            else                                                                                                                                                                    
              ln -sfn "${OPENBLAS_ROOT}/lib/libopenblas.a" "${KALDI_ROOT}/tools/OpenBLAS/install/lib/liblapacke.a"                                                                  
            fi                                                                                                                                                                      
                                                                                                                                                                                    
            ln -sfn "${OPENBLAS_ROOT}/lib/libopenblas.a" "${KALDI_ROOT}/tools/OpenBLAS/install/lib/libblas.a"                                                                       
                                                                                                                                                                                    
            cd "${KALDI_DIR}/tools"                                                                                                                                                 
            extras/check_dependencies.sh || true                                                                                                                                    
            make                                                                                                                                                                    
                                                                                                                                                                                    
            cd "${KALDI_DIR}/src"                                                                                                                                                   
            ./configure --shared --static --use-cuda=no --openblas-root="${OPENBLAS_ROOT}"                                                                                          
            make clean                                                                                                                                                              
            make                                                                                                                                                                    
                                                                                                                                                                                    
            git clone --depth 1 --branch v0.3.45 https://github.com/alphacep/vosk-api.git "${VOSK_DIR}"                                                                             
            cd "${VOSK_DIR}"                                                                                                                                                        
                                                                                                                                                                                    
            sed -i 's/#include "decoder\/decoder-wrappers.h"/&\n#include "lat\/word-align-lattice.h"/' src/recognizer.cc                                                            
            sed -i 's/        WordAlignLatticePartial(/        kaldi::WordAlignLattice(/' src/recognizer.cc                                                                         
                                                                                                                                                                                    
            export LD_LIBRARY_PATH="${KALDI_ROOT}/src/lib:${LD_LIBRARY_PATH:-}"                                                                                                     
            make -C src                                                                                                                                                             
            make java                                                                                                                                                               
                                                                                                                                                                                    
            strip java/lib/linux-aarch64/libvosk.so                                                                                                                                 
            strip java/lib/linux-aarch64/libvosk_jni.so                                                                                                                             
                                                                                                                                                                                    
            mkdir -p "${WORKDIR}/artifacts/lib"                                                                                                                                     
            cp java/lib/linux-aarch64/libvosk.so      "${WORKDIR}/artifacts/lib/"                                                                                                   
            cp java/lib/linux-aarch64/libvosk_jni.so  "${WORKDIR}/artifacts/lib/"                                                                                                   
            cp java/lib/linux-aarch64/vosk.jar        "${WORKDIR}/artifacts/"                                                                                                       
                                                                                                                                                                                    
            rm -rf "${BUILD_DIR}"                                                                                                                                                   
                                                                                                                                                                                    
        - name: List artifacts                                                                                                                                                      
          run: ls -R artifacts                                                                                                                                                      
                                                                                                                                                                                    
        - name: Upload artifacts                                                                                                                                                    
          uses: actions/upload-artifact@v4                                                                                                                                          
          with:                                                                                                                                                                     
            name: vosk-arm64-jni                                                                                                                                                    
            path: artifacts         
