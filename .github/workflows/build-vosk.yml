  name: Build Vosk ARM64                                                                                                                                                            
                                                                                                                                                                                    
  on:                                                                                                                                                                               
    workflow_dispatch:                                                                                                                                                              
                                                                                                                                                                                    
  jobs:                                                                                                                                                                             
    build:                                                                                                                                                                          
      runs-on: ubuntu-22.04-arm                                                                                                                                                     
                                                                                                                                                                                    
      steps:                                                                                                                                                                        
        - uses: actions/checkout@v4                                                                                                                                                 
                                                                                                                                                                                    
        - name: Define build paths                                                                                                                                                  
          run: |                                                                                                                                                                    
            set -eux                                                                                                                                                                
            BUILD_DIR="$RUNNER_TEMP/vosk-build"                                                                                                                                     
            OPENBLAS_INSTALL="$BUILD_DIR/openblas-install"                                                                                                                          
            KALDI_DIR="$BUILD_DIR/kaldi"                                                                                                                                            
            VOSK_DIR="$BUILD_DIR/vosk-api"                                                                                                                                          
            echo "BUILD_DIR=$BUILD_DIR" >> "$GITHUB_ENV"                                                                                                                            
            echo "OPENBLAS_INSTALL=$OPENBLAS_INSTALL" >> "$GITHUB_ENV"                                                                                                              
            echo "KALDI_DIR=$KALDI_DIR" >> "$GITHUB_ENV"                                                                                                                            
            echo "VOSK_DIR=$VOSK_DIR" >> "$GITHUB_ENV"                                                                                                                              
                                                                                                                                                                                    
        - name: Install prerequisites                                                                                                                                               
          run: |                                                                                                                                                                    
            set -eux                                                                                                                                                                
            sudo apt-get update                                                                                                                                                     
            sudo apt-get install -y --no-install-recommends \                                                                                                                       
              build-essential \                                                                                                                                                     
              gfortran \                                                                                                                                                            
              git \                                                                                                                                                                 
              cmake \                                                                                                                                                               
              automake \                                                                                                                                                            
              autoconf \                                                                                                                                                            
              libtool \                                                                                                                                                             
              python3 \                                                                                                                                                             
              python3-dev \                                                                                                                                                         
              python3-distutils \                                                                                                                                                   
              python3-pip \                                                                                                                                                         
              sox \                                                                                                                                                                 
              wget \                                                                                                                                                                
              zlib1g-dev \                                                                                                                                                          
              pkg-config \                                                                                                                                                          
              unzip \                                                                                                                                                               
              curl                                                                                                                                                                  
                                                                                                                                                                                    
        - name: Prepare build directories                                                                                                                                           
          run: |                                                                                                                                                                    
            set -eux                                                                                                                                                                
            rm -rf "$BUILD_DIR"                                                                                                                                                     
            mkdir -p "$BUILD_DIR"                                                                                                                                                   
            mkdir -p "$OPENBLAS_INSTALL"                                                                                                                                            
                                                                                                                                                                                    
        - name: Build OpenBLAS (static + shared, no OpenMP)                                                                                                                         
          run: |                                                                                                                                                                    
            set -eux                                                                                                                                                                
            cd "$BUILD_DIR"                                                                                                                                                         
            git clone --depth 1 --branch v0.3.13 https://github.com/OpenMathLib/OpenBLAS.git openblas-src                                                                           
            cd openblas-src                                                                                                                                                         
            make -j"$(nproc)" TARGET=ARMV8 USE_OPENMP=0                                                                                                                             
            make PREFIX="$OPENBLAS_INSTALL" install                                                                                                                                 
            cd "$OPENBLAS_INSTALL/lib"                                                                                                                                              
            for name in blas lapack; do                                                                                                                                             
              ln -sf libopenblas.a "lib${name}.a"                                                                                                                                   
              ln -sf libopenblas.so "lib${name}.so"                                                                                                                                 
            done                                                                                                                                                                    
                                                                                                                                                                                    
        - name: Build Kaldi core libraries                                                                                                                                          
          run: |                                                                                                                                                                    
            set -eux                                                                                                                                                                
            cd "$BUILD_DIR"                                                                                                                                                         
            git clone --depth 1 https://github.com/alphacep/kaldi.git kaldi                                                                                                         
            cd kaldi/tools                                                                                                                                                          
            extras/check_dependencies.sh || true                                                                                                                                    
            make OPENFST_CONFIGURE="--enable-static --enable-shared --with-pic --enable-ngram-fsts" -j"$(nproc)"                                                                    
            cd ../src                                                                                                                                                               
            CXXFLAGS="-fPIC -O2 -march=armv8-a -std=c++14" CFLAGS="-fPIC -O2 -march=armv8-a" \                                                                                      
              ./configure --shared --static --use-cuda=no --openblas-root="$OPENBLAS_INSTALL"                                                                                       
            make clean                                                                                                                                                              
            make -j"$(nproc)" \                                                                                                                                                     
              kaldi-online2 kaldi-decoder kaldi-ivector kaldi-gmm kaldi-tree \                                                                                                      
              kaldi-feat kaldi-lat kaldi-lm kaldi-rnnlm kaldi-hmm kaldi-nnet3 \                                                                                                     
              kaldi-transform kaldi-cudamatrix kaldi-matrix kaldi-fstext kaldi-util kaldi-base                                                                                      
                                                                                                                                                                                    
        - name: Build Vosk libraries                                                                                                                                                
          run: |                                                                                                                                                                    
            set -eux                                                                                                                                                                
            cd "$BUILD_DIR"                                                                                                                                                         
            git clone --depth 1 --branch v0.3.45 https://github.com/alphacep/vosk-api.git vosk-api                                                                                  
            cd vosk-api                                                                                                                                                             
            sed -i 's|#include "decoder/decoder-wrappers.h"|#include "decoder/decoder-wrappers.h"\n#include "lat/word-align-lattice.h"|' src/recognizer.cc                          
            sed -i 's/WordAlignLatticePartial(/kaldi::WordAlignLattice(/g' src/recognizer.cc                                                                                        
            sed -i 's|install/lib/liblapacke.a install/lib/libf2c.a|install/lib/liblapacke.a|' src/Makefile                                                                         
            export KALDI_ROOT="$KALDI_DIR"                                                                                                                                          
            export LD_LIBRARY_PATH="$KALDI_DIR/src/lib:$LD_LIBRARY_PATH"                                                                                                            
            make -C src clean                                                                                                                                                       
            make -C src -j"$(nproc)"                                                                                                                                                
                                                                                                                                                                                    
        - name: Collect artifacts                                                                                                                                                   
          run: |                                                                                                                                                                    
            set -eux                                                                                                                                                                
            ART_DIR="$BUILD_DIR/artifacts"                                                                                                                                          
            mkdir -p "$ART_DIR/lib"                                                                                                                                                 
            mkdir -p "$ART_DIR/include"                                                                                                                                             
            cp "$VOSK_DIR/src/libvosk.so" "$ART_DIR/lib/"                                                                                                                           
            if [ -f "$VOSK_DIR/src/libvosk_jni.so" ]; then                                                                                                                          
              cp "$VOSK_DIR/src/libvosk_jni.so" "$ART_DIR/lib/"                                                                                                                     
            fi                                                                                                                                                                      
            cp "$VOSK_DIR/src/"*.h "$ART_DIR/include/"                                                                                                                              
            printf 'git_commit=%s\n' "$(cd "$VOSK_DIR" && git rev-parse HEAD)" > "$ART_DIR/build-info.txt"                                                                          
                                                                                                                                                                                    
        - name: Upload libraries                                                                                                                                                    
          uses: actions/upload-artifact@v4                                                                                                                                          
          with:                                                                                                                                                                     
            name: vosk-arm64-libs                                                                                                                                                   
            path: ${{ env.BUILD_DIR }}/artifacts 
