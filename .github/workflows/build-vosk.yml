  name: Build Vosk ARM64 JNI                                                                                                                                                        
                                                                                                                                                                                    
  on:                                                                                                                                                                               
    workflow_dispatch:                                                                                                                                                              
                                                                                                                                                                                    
  jobs:                                                                                                                                                                             
    build-arm64:                                                                                                                                                                    
      runs-on: ubuntu-20.04                                                                                                                                                         
                                                                                                                                                                                    
      steps:                                                                                                                                                                        
                                                                                                                                                         
                                                                                                                                                                                    
        # 拉取官方 vosk-api 仓库                                                                                                                                                    
        - name: Checkout official vosk-api                                                                                                                                          
          uses: actions/checkout@v4                                                                                                                                                 
          with:                                                                                                                                                                     
            repository: alphacep/vosk-api                                                                                                                                           
            ref: v0.3.45                                                                                                                                                            
            submodules: true                                                                                                                                                        
            fetch-depth: 0                                                                                                                                                          
            path: vosk                                                                                                                                                              
                                                                                                                                                                                    
        # 在 arm64 Ubuntu 22.04 容器里执行编译                                                                                                                                      
        - name: Build on arm64                                                                                                                                                      
          uses: uraimo/run-on-arch-action@v2                                                                                                                                        
          with:                                                                                                                                                                     
            arch: arm64                                                                                                                                                             
            distro: ubuntu22.04                                                                                                                                                     
            install: |                                                                                                                                                              
              apt-get update                                                                                                                                                        
              apt-get install -y \                                                                                                                                                  
                git curl build-essential cmake ninja-build swig \                                                                                                                   
                openjdk-11-jdk python3 python3-pip python3-setuptools \                                                                                                             
                maven libtool automake autoconf \                                                                                                                                   
                zlib1g-dev libopenblas-dev libomp5 libgfortran5 \                                                                                                                   
                sox ffmpeg                                                                                                                                                          
            run: |                                                                                                                                                                  
              set -eux                                                                                                                                                              
              cd /github/workspace/vosk                                                                                                                                             
              # 安装 Kaldi/OpenFST 依赖与源码                                                                                                                                       
              ./travis/install-linux-kaldi-deps.sh                                                                                                                                  
              ./travis/install-kaldi.sh                                                                                                                                             
              # 编译 Vosk 主体                                                                                                                                                      
              make -C src                                                                                                                                                           
              make java                                                                                                                                                             
              # 若需要，可 strip 减小体积                                                                                                                                           
              strip java/lib/linux-aarch64/libvosk.so                                                                                                                               
              strip java/lib/linux-aarch64/libvosk_jni.so                                                                                                                           
                                                                                                                                                                                    
        # 收集 build 产物                                                                                                                                                           
        - name: Collect artifacts                                                                                                                                                   
          run: |                                                                                                                                                                    
            mkdir -p artifacts/lib                                                                                                                                                  
            cp vosk/java/lib/linux-aarch64/libvosk.so artifacts/lib/                                                                                                                
            cp vosk/java/lib/linux-aarch64/libvosk_jni.so artifacts/lib/                                                                                                            
            cp vosk/java/lib/linux-aarch64/vosk.jar artifacts/                                                                                                                      
            ls -R artifacts                                                                                                                                                         
                                                                                                                                                                                    
        # 上传 Artifact，方便下载                                                                                                                                                   
        - name: Upload artifacts                                                                                                                                                    
          uses: actions/upload-artifact@v4                                                                                                                                          
          with:                                                                                                                                                                     
            name: vosk-arm64-jni                                                                                                                                                    
            path: artifacts                                                                                                                                                         
                                  
