 name: Build Vosk ARM64 JNI                                                                                                                                                        
                                                                                                                                                                                    
  on:                                                                                                                                                                               
    workflow_dispatch:                                                                                                                                                              
                                                                                                                                                                                    
  jobs:                                                                                                                                                                             
    build-arm64:                                                                                                                                                                    
      runs-on: ubuntu-22.04                                                                                                                                                         
                                                                                                                                                                                    
      steps:                                                                                                                                                                        
        - name: Build in arm64 container                                                                                                                                            
          uses: uraimo/run-on-arch-action@v2                                                                                                                                        
          with:                                                                                                                                                                     
            arch: arm64                                                                                                                                                             
            base_image: ubuntu:20.04                                                                                                                                                
            install: >                                                                                                                                                              
              apt-get update && apt-get install -y                                                                                                                                  
              git curl ca-certificates build-essential cmake ninja-build swig                                                                                                       
              openjdk-8-jdk python3 python3-pip python3-setuptools                                                                                                                  
              python2 python2-dev wget unzip subversion gfortran                                                                                                                    
              maven libtool automake autoconf zlib1g-dev libopenblas-dev libomp5 libgfortran5                                                                                       
              sox ffmpeg pkg-config                                                                                                                                                 
            run: |                                                                                                                                                                  
              set -eux                                                                                                                                                              
              NPROC=$(nproc || echo 2)                                                                                                                                              
                                                                                                                                                                                    
              # --- 1. Kaldi ---                                                                                                                                                    
              mkdir -p /tmp/vosk-build                                                                                                                                              
              cd /tmp/vosk-build                                                                                                                                                    
              git clone --depth 1 https://github.com/alphacep/kaldi.git                                                                                                             
              export KALDI_ROOT=/tmp/vosk-build/kaldi                                                                                                                               
                                                                                                                                                                                    
              cd ${KALDI_ROOT}/tools                                                                                                                                                
              extras/check_dependencies.sh || true                                                                                                                                  
              make -j${NPROC}                                                                                                                                                       
                                                                                                                                                                                    
              cd ${KALDI_ROOT}/src                                                                                                                                                  
              ./configure --shared --static --use-cuda=no --mathlib=OPENBLAS                                                                                                        
              make clean                                                                                                                                                            
              make -j${NPROC}                                                                                                                                                       
                                                                                                                                                                                    
              # --- 2. Vosk ---                                                                                                                                                     
              cd /tmp/vosk-build                                                                                                                                                    
              git clone --depth 1 --branch v0.3.45 https://github.com/alphacep/vosk-api.git                                                                                         
              cd vosk-api                                                                                                                                                           
                                                                                                                                                                                    
              export KALDI_ROOT=/tmp/vosk-build/kaldi                                                                                                                               
              export LD_LIBRARY_PATH="${KALDI_ROOT}/src/lib:${LD_LIBRARY_PATH:-}"                                                                                                   
                                                                                                                                                                                    
              make -C src                                                                                                                                                           
              make java                                                                                                                                                             
                                                                                                                                                                                    
              strip java/lib/linux-aarch64/libvosk.so                                                                                                                               
              strip java/lib/linux-aarch64/libvosk_jni.so                                                                                                                           
                                                                                                                                                                                    
              mkdir -p /github/workspace/artifacts/lib                                                                                                                              
              cp java/lib/linux-aarch64/libvosk.so /github/workspace/artifacts/lib/                                                                                                 
              cp java/lib/linux-aarch64/libvosk_jni.so /github/workspace/artifacts/lib/                                                                                             
              cp java/lib/linux-aarch64/vosk.jar /github/workspace/artifacts/                                                                                                       
                                                                                                                                                                                    
        - name: List artifacts                                                                                                                                                      
          run: ls -R artifacts                                                                                                                                                      
                                                                                                                                                                                    
        - name: Upload artifacts                                                                                                                                                    
          uses: actions/upload-artifact@v4                                                                                                                                          
          with:                                                                                                                                                                     
            name: vosk-arm64-jni                                                                                                                                                    
            path: artifacts                                                                                                                                                         
                                           
